name: Build and push Docker image

on:
  push:
    branches:
      - main
      - test-lacework
    paths:
      - Makefile
      - Dockerfile
      - .dockerignore
      - "**.go"
      - "go.mod"
      - .github/workflows/main.yaml

jobs:
  build-publish:
    runs-on: ubuntu-latest

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Log in to the Container registry
        uses: docker/login-action
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: make docker-build
        
      - name: Scan container images for vulnerabitilies using Lacework
        uses: lacework/lw-scanner-action@v0.6.0
        with:
          LW_ACCOUNT_NAME: ${{ secrets.LW_ACCOUNT_NAME }} 
          LW_ACCESS_TOKEN: ${{ secrets.LW_ACCESS_TOKEN }}
          IMAGE_NAME: ghcr.io/huma-engineering/compose-operator
          IMAGE_TAG: ${{github.run_number}}
          SAVE_RESULTS_IN_LACEWORK: true
#           SAVE_BUILD_REPORT: true
#           BUILD_REPORT_FILE_NAME: myreport.html
#           FAIL_BUILD: true
          SEVERITY_THRESHOLD: fixable
          
      - name: Publish Docker image
        run: make docker-push
